---
title: 宏任务和微任务
date: 2018-05-30
tags:
 - 基础        
categories: 
 - javascript
---

## 前言

> JavaScript是**单线程**的，同一时间只能做一件事情。如果碰到某个耗时长的任务（比如一个需要 3s 的网络请求），那么后续的任务都要等待，这种效果是无法接受的，这时我们就引入了异步任务的概念。
 所以 JS 执行主要包括同步任务和异步任务,JS 的事件循环机制，它主要与异步任务有关。
> + 同步任务：会放入到执行栈中，他们是要按顺序执行的任务；
> + 异步任务：会放入到任务队列中，这些异步任务一定要等到执行栈清空后才会执行，也就是说异步任务一定是在同步任务之后执行的。

## 任务队列
事件循环主要与任务队列有关，所以必须要先知道宏任务与微任务。

在任务队列中，有两种任务：**宏任务**和**微任务**。

`宏任务`：script标签中的整体代码、setTimeout、setInterval、setImmediate、I/0、UI渲染

`微任务`：process.nextTick（Node.js）、promise、Object.observe（不常用）、MutationObserver（Node.js）

任务优先级：process.nextTick > Promise.then > setTimeout > setImmediate

以上这些是常见的宏任务和微任务，记住就行了，不用追究为什么它是宏任务或微任务，因为就是这样的。
## 事件循环
事件循环（Event Loop）就是：
+ 一开始整个脚本（script标签中的整体代码）作为一个宏任务执行；
+ 执行过程中同步代码直接执行，宏任务进入宏任务队列，微任务进入微任务队列；
+ 当前宏任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）；
+ 当前宏任务执行完毕，开始检查渲染，然后 GUI 线程接管渲染（浏览器会在两个宏任务交接期间，对页面进行重新渲染）；
+ 渲染完毕后，JS 线程继续接管，开始下一个宏任务（从任务队列中获取），依此循环，直到宏任务和微任务队列都为空。
> 说的通俗一点：微任务是跟屁虫，一直跟着当前宏任务后面：代码执行过程中，每当碰到一个微任务，就马上跟在当前宏任务后面；当碰到一个宏任务，那不好意思你排到下一次循环再说。

**同一个事件循环中，微任务永远在宏任务之前执行**
